<!DOCTYPE HTML>
<html>
<head>
	<meta charset="UTF-8"/>	
	<title>World Sculptor 0.0.1</title>
	<link rel="icon" href="data/vectory_icon.png" type="image/png">
	
	<script src="../jabaku/math/Matrix3.js" type="text/javascript"></script>
	<script src="../jabaku/math/Matrix4.js" type="text/javascript"></script>
	<script src="../jabaku/math/Vector2.js" type="text/javascript"></script>
	<script src="../jabaku/math/Vector3.js" type="text/javascript"></script>
	<script src="../jabaku/math/Vector4.js" type="text/javascript"></script>
	<script src="../jabaku/math/Quaternion.js" type="text/javascript"></script>
	<script src="../jabaku/math/Ray.js" type="text/javascript"></script>
	<script src="../jabaku/math/Mathutils.js" type="text/javascript"></script>

	<script src="../jabaku/engine/webgl-debug.js" type="text/javascript"></script>
	<script src="../jabaku/engine/utils.js" type="text/javascript"></script>
	<script src="../jabaku/engine/fileutils.js" type="text/javascript"></script>
	<script src="../jabaku/engine/webgl_utils.js" type="text/javascript"></script>
	<script src="../jabaku/engine/engine3d.js" type="text/javascript"></script>
	<script src="../jabaku/engine/color.js" type="text/javascript"></script>
	<script src="../jabaku/engine/mesh.js" type="text/javascript"></script>
	<script src="../jabaku/engine/material.js" type="text/javascript"></script>
	<script src="../jabaku/engine/point_light.js" type="text/javascript"></script>
	<script src="../jabaku/engine/forward_light_settings.js" type="text/javascript"></script>
	<script src="../jabaku/engine/texture_atlas.js" type="text/javascript"></script>
	<script src="../jabaku/engine/camera.js" type="text/javascript"></script>
	<script src="../jabaku/engine/viewport.js" type="text/javascript"></script>
	<script src="../jabaku/engine/text.js" type="text/javascript"></script>
	<script src="../jabaku/engine/mesh_library.js" type="text/javascript"></script>
	<script src="../jabaku/engine/transform.js" type="text/javascript"></script>
	<script src="../jabaku/engine/render_batch.js" type="text/javascript"></script>

	<script src="../jabaku/renderer/renderer_utils.js" type="text/javascript"></script>
	<script src="../jabaku/renderer/simple_forward_renderer.js" type="text/javascript"></script>
	<script src="../jabaku/renderer/depth_peeling_renderer.js" type="text/javascript"></script>
	<script src="../jabaku/renderer/wireframe_renderer.js" type="text/javascript"></script>
	<script src="../jabaku/renderer/id_renderer.js" type="text/javascript"></script>

	<script src="../jabaku/entity_system/entity_system.js" type="text/javascript"></script>
	<script src="../jabaku/entity_system/system_base.js" type="text/javascript"></script>

	<script src="../jabaku/profiler/profiler.js" type="text/javascript"></script>
</head>
<body>
<canvas id="canvas" width="1024" height="768"></canvas>

<script>
	window.requestAnimFrame = (function () {
		return window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback){
				window.setTimeout(callback, 1000 / 60);
			};
	}) ();
	
	function startAnimation(canvas, engine, programs, meshLib, quadMesh) {
		(function animate() {
			engine.clear();

			engine.withProgram(programs.SCREENSPACE, function(withParameters) {
				withParameters({
					uWorld: new Matrix4()
						.translate(new Vector3(canvas.width * 0.5, canvas.height * 0.5, 0.0))
						.scale(new Vector3(400, 300, 1.0))
						.val,
					uScreenSize: [canvas.width, canvas.height],
					uColor: [1.0, 1.0, 0.0, 1.0],
					uTexture: {}
				}, function(withBuffers) {
					meshLib.render(withBuffers, quadMesh);
				});
			});

			requestAnimFrame(animate);
		})();
	}
	
	function extractMouseCoords(canvas, evt){
		// get canvas position
		var obj = canvas;
		var top = 0;
		var left = 0;
		while (obj && obj.tagName != 'BODY') {
			top += obj.offsetTop;
			left += obj.offsetLeft;
			obj = obj.offsetParent;
		}

		// return relative mouse position
		var mouseX = evt.clientX - left + window.pageXOffset;
		var mouseY = evt.clientY - top + window.pageYOffset;
		return {
			x: mouseX,
			y: mouseY
		};
	}

	var wheelDistance = function(evt) {
		if (!evt) evt = event;
			var w = evt.wheelDelta, d = evt.detail;
			if (d) {
				if (w) {
					return w / d / 40 * ((d > 0) ? 1 : -1); // Opera
				} else {
					return -d/3; // Firefox;
				}
			} else {
				return w/120; // IE/Safari/Chrome
			}
	};

	var ShaderPrograms = {
		SIMPLE: { vertex: 'assets/shaders/simple.vshader', fragment: 'assets/shaders/simple.fshader' },
		SCREENSPACE: { vertex: 'assets/shaders/screenspace.vshader', fragment: 'assets/shaders/screenspace.fshader' }
	};

	function start() {
		var canvas = document.getElementById('canvas');
		
		var engine = Engine3D(canvas, true);
		engine.setClearColor(Color.make(0.2, 0.2, 0.2));
//		engine.setBlendMode(BlendMode.SOLID);

		var programs = {};
		for (var key in ShaderPrograms) {
			var desc = ShaderPrograms[key];
			programs[key] = engine.createProgram(FileUtils.loadFile(desc.vertex), FileUtils.loadFile(desc.fragment), key);
		}

		var meshLib = Mesh(engine.createVertexBuffer, engine.createIndexBuffer);

		var quadMesh = meshLib.make( MeshUtils.createScreenQuadData() );
		
		startAnimation(canvas, engine, programs, meshLib, quadMesh);
	}
	
	start();
</script>
</body>
</html>